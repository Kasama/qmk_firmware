#include <stdint.h>
#include <string.h>
#include "sendstring_brazilian_abnt2.h"
#include "raw_hid.h"
#include QMK_KEYBOARD_H
#include "numpad.h"

enum layers {
    _QWERTY = 0,
    _SYS,
    _NUMROW,
    _GAME,
    _CODE,
    _NUMPAD,
    // _TRANS = 15
};

#define SFT_ESC  SFT_T(KC_ESC)
#define C_BSPC   CTL_T(KC_BSPC)
#define C_ESC   CTL_T(KC_ESC)
#define ALT_SPC  RALT_T(KC_SPC)
#define ALT_TAB  ALT_T(KC_TAB)
#define ALT_LBC  ALT_T(KC_TAB)
#define SFT_ENT  RSFT_T(KC_ENT)
#define SFT_DQUO SFT_T(BR_DQUO)

#define COD_ESC LT(_CODE, KC_ESC)

// homerow tap mod keys
#define HM_SA SFT_T(KC_A)
#define HM_CS CTL_T(KC_S)
#define HM_AD ALT_T(KC_D)
#define HM_GF GUI_T(KC_F)

#define HM_GJ GUI_T(KC_J)
#define HM_AK ALT_T(KC_K)
#define HM_CL CTL_T(KC_L)
#define HM_SÇ SFT_T(BR_SCLN)

#define KC_ML KC_MS_LEFT
#define KC_MR KC_MS_RIGHT
#define KC_MU KC_MS_UP
#define KC_MD KC_MS_DOWN
#define KC_MB1 KC_MS_BTN1
#define KC_MB2 KC_MS_BTN2
#define KC_PRINT KC_PRINT_SCREEN

#define SYSTM OSL(_SYS)
#define NUMROW OSL(_NUMROW)
#define CODE OSL(_CODE)

#define NUMPAD MO(_NUMPAD)

#define LOWER_R OSL(_NUMROW)
#define LOWER_B OSL(_NUMROW)

#define BR_RCBR S(BR_RBRC)
#define BR_LCBR S(BR_LBRC)

enum custom_keycodes {
    K_VIMCMD = SAFE_RANGE,
};

// Combos
const uint16_t PROGMEM c_escbspc[] = {COD_ESC, C_BSPC, COMBO_END};
const uint16_t PROGMEM c_systab[]  = {SYSTM, ALT_TAB, COMBO_END};
const uint16_t PROGMEM c_sysesc[]  = {SYSTM, COD_ESC, COMBO_END};
const uint16_t PROGMEM c_jk[] = {KC_J, KC_K, COMBO_END};
const uint16_t PROGMEM c_lç[] = {KC_L, HM_SÇ, COMBO_END};
const uint16_t PROGMEM c_as[] = {KC_A, KC_S, COMBO_END};
const uint16_t PROGMEM c_atab[] = {KC_A, ALT_TAB, COMBO_END};
const uint16_t PROGMEM c_u_idx_homerow_r[] = {KC_Y, KC_I, KC_O, KC_P, COMBO_END};
const uint16_t PROGMEM c_l_homerow_r[]     = {KC_M, KC_COMM, KC_DOT, BR_SLSH, COMBO_END};
const uint16_t PROGMEM c_l_idx_homerow_r[] = {KC_N, KC_COMM, KC_DOT, BR_SLSH, COMBO_END};
const uint16_t PROGMEM c_homerow_l[]     = {KC_A, KC_S, KC_D, KC_F, COMBO_END};
const uint16_t PROGMEM c_idx_homerow_l[] = {KC_A, KC_S, KC_D, KC_G, COMBO_END};

combo_t key_combos[] = {
    COMBO(c_jk, KC_ESC),
    COMBO(c_escbspc, LM(_NUMROW, MOD_LGUI)),
    COMBO(c_systab, LM(_NUMROW, MOD_LGUI)),
    COMBO(c_sysesc, TG(_GAME)),
    COMBO(c_u_idx_homerow_r, QK_BOOT),
    COMBO(c_l_idx_homerow_r, QK_MAKE),
    COMBO(c_lç, K_VIMCMD),
    COMBO(c_homerow_l, NUMPAD),
    COMBO(c_idx_homerow_l, KC_ENTER),
    COMBO(c_as, OSM(MOD_LSFT)),
    COMBO(c_atab, KC_LGUI),
};

bool combo_should_trigger(uint16_t combo_index, combo_t *combo, uint16_t keycode, keyrecord_t *record) {
  if (layer_state_is(_GAME)) {
    return false;
  }

  return true;
}


const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {
  [_QWERTY] = LAYOUT(
  //┌────────┬────────┬────────┬────────┬────────┬────────┐                                           ┌────────┬────────┬────────┬────────┬────────┬────────┐
     XXXXXXX ,KC_1    ,KC_2    ,KC_3    ,KC_4    ,KC_5    ,                                            KC_6    ,KC_7    ,KC_8    ,KC_9    ,KC_0    ,XXXXXXX ,
  //├────────┼────────┼────────┼────────┼────────┼────────┼────────┐                         ┌────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     KC_TAB  ,KC_Q    ,KC_W    ,KC_E    ,KC_R    ,KC_T    ,XXXXXXX ,                          XXXXXXX ,KC_Y    ,KC_U    ,KC_I    ,KC_O    ,KC_P    ,XXXXXXX ,
  //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤                         ├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
      C_ESC  ,KC_A    ,KC_S    ,KC_D    ,KC_F    ,KC_G    ,XXXXXXX ,                          XXXXXXX ,KC_H    ,KC_J    ,KC_K    ,KC_L    , HM_SÇ  ,XXXXXXX ,
  //├────────┼────────┼────────┼────────┼────────┼────────┼────────┼────────┐       ┌────────┼────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     KC_LSFT ,KC_Z    ,KC_X    ,KC_C    ,KC_V    ,KC_B    ,XXXXXXX ,XXXXXXX ,        XXXXXXX ,XXXXXXX ,KC_N    ,KC_M    ,KC_COMM ,KC_DOT  ,BR_SLSH ,XXXXXXX ,
  //├────────┼────────┼────────┼────────┼────┬───┴────┬───┼────────┼────────┤       ├────────┼────────┼───┬────┴───┬────┼────────┼────────┼────────┼────────┤
     KC_LGUI ,XXXXXXX ,BR_LBRC ,BR_RBRC ,     COD_ESC ,     C_BSPC ,ALT_TAB ,        SFT_ENT ,ALT_SPC ,    NUMROW       ,KC_MINS ,KC_EQL  ,KC_UP   ,XXXXXXX
  //└────────┴────────┴────────┴────────┘    └────────┘   └────────┴────────┘       └────────┴────────┘   └────────┘    └────────┴────────┴────────┴────────┘
  ),

  [_CODE] = LAYOUT(
  //┌────────┬────────┬────────┬────────┬────────┬────────┐                                           ┌────────┬────────┬────────┬────────┬────────┬────────┐
     _______ ,_______ ,_______ ,_______ ,_______ ,_______ ,                                            _______ ,_______ ,_______ ,_______ ,_______ ,_______ ,
  //├────────┼────────┼────────┼────────┼────────┼────────┼────────┐                         ┌────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     _______ ,BR_QUOT ,BR_DQUO ,_______ ,_______ ,_______ ,_______ ,                          _______ ,KC_PRINT,BR_LBRC ,BR_RBRC ,BR_GRV  ,BR_ACUT ,_______ ,
  //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤                         ├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     _______ ,SFT_DQUO,_______ ,KC_DEL  ,_______ ,_______ ,_______ ,                          _______ ,_______ ,KC_LPRN ,KC_RPRN ,BR_CIRC ,BR_TILD ,_______ ,
  //├────────┼────────┼────────┼────────┼────────┼────────┼────────┼────────┐       ┌────────┼────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     _______ ,BR_BSLS ,KC_CAPS ,BR_CCED ,_______ ,_______ ,_______ ,_______ ,        _______ ,_______ ,_______ ,BR_LCBR ,BR_RCBR ,BR_SCLN ,BR_PIPE ,_______ ,
  //├────────┼────────┼────────┼────────┼────┬───┴────┬───┼────────┼────────┤       ├────────┼────────┼───┬────┴───┬────┼────────┼────────┼────────┼────────┤
     _______ ,_______ ,_______ ,_______ ,     _______ ,    _______ ,_______ ,        _______ ,_______ ,    _______ ,   S(KC_MINS),KC_PLUS ,_______ ,_______
  //└────────┴────────┴────────┴────────┘    └────────┘   └────────┴────────┘       └────────┴────────┘   └────────┘    └────────┴────────┴────────┴────────┘
  ),

  [_SYS] = LAYOUT(
  //┌────────┬────────┬────────┬────────┬────────┬────────┐                                           ┌────────┬────────┬────────┬────────┬────────┬────────┐
     _______ ,KC_F1   ,KC_F2   ,KC_F3   ,KC_F4   ,KC_F5   ,                                            KC_F6   ,KC_F7   ,KC_F8   ,KC_F9   ,KC_F10  ,_______ ,
  //├────────┼────────┬────────┬────────┬────────┬────────┼────────┐                         ┌────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     _______ , QK_BOOT, _______, KC_MU,   _______, AC_TOGG,_______ ,                          _______ ,KC_VOLD , KC_MUTE, KC_VOLU, _______, KC_PGUP,_______ ,
  //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤                         ├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     _______ , BR_QUOT, KC_ML,   KC_MD,   KC_MR,   KC_F23 ,_______ ,                          _______ ,KC_LEFT , KC_DOWN, KC_UP,   KC_RGHT, KC_PGDN,_______ ,
  //├────────┼────────┼────────┼────────┼────────┼────────┼────────┼────────┐       ┌────────┼────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     _______ , BR_BSLS, KC_MPRV, KC_MPLY, KC_MNXT, _______,_______ ,_______ ,        _______ ,QK_BOOT , KC_F23 , KC_SLSH, KC_BSLS, KC_QUES, KC_PIPE,_______ ,
  //├────────┼────────┼────────┼────────┼────────┴────────┼────────┼────────┤       ├────────┼────────┼───┬────┴───┬────┼────────┼────────┼────────┼────────┤
     _______ ,_______ ,_______ ,_______ ,     _______ ,    _______ ,NUMPAD  ,        _______ ,_______ ,    _______ ,     KC_MB1  ,KC_MB2  ,_______ ,_______
  //└────────┴────────┴────────┴────────┘    └────────┘   └────────┴────────┘       └────────┴────────┘   └────────┘    └────────┴────────┴────────┴────────┘
  ),

  [_NUMROW] = LAYOUT(
  //┌────────┬────────┬────────┬────────┬────────┬────────┐                                           ┌────────┬────────┬────────┬────────┬────────┬────────┐
     _______ ,_______ ,_______ ,_______ ,_______ ,_______ ,                                            _______ ,_______ ,_______ ,_______ ,_______ ,_______ ,
  //├────────┼────────┼────────┼────────┼────────┼────────┼────────┐                         ┌────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     _______ ,   KC_F1,   KC_F2,   KC_F3,   KC_F4,   KC_F5,_______ ,                          _______ ,   KC_F6,   KC_F7,   KC_F8,   KC_F9,  KC_F10,_______ ,
  //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤                         ├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     _______ ,    KC_1,    KC_2,    KC_3,    KC_4,    KC_5,_______ ,                          _______ ,    KC_6,    KC_7,    KC_8,    KC_9,    KC_0,_______ ,
  //├────────┼────────┼────────┼────────┼────────┼────────┼────────┼────────┐       ┌────────┼────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     _______ , KC_EXLM, KC_AT,   KC_HASH, KC_DLR,  KC_PERC,_______ ,_______ ,        _______ ,_______ , KC_CIRC, KC_AMPR, KC_ASTR, KC_LPRN, KC_RPRN,_______ ,
  //├────────┼────────┼────────┼────────┼────┬───┴────┬───┼────────┼────────┤       ├────────┼────────┼───┬────┴───┬────┼────────┼────────┼────────┼────────┤
     _______ ,_______ ,_______ ,_______ ,     _______ ,    _______ ,_______ ,        _______ ,_______ ,    _______ ,     _______ ,_______ ,_______ ,_______
  //└────────┴────────┴────────┴────────┘    └────────┘   └────────┴────────┘       └────────┴────────┘   └────────┘    └────────┴────────┴────────┴────────┘
  ),

  [_NUMPAD] = LAYOUT(
  //┌────────┬────────┬────────┬────────┬────────┬────────┐                                           ┌────────┬────────┬────────┬────────┬────────┬────────┐
     _______ ,_______ ,_______ ,_______ ,_______ ,_______ ,                                            _______ ,_______ ,_______ ,_______ ,_______ ,_______ ,
  //├────────┼────────┼────────┼────────┼────────┼────────┼────────┐                         ┌────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     _______ , _______, BR_LBRC, BR_RBRC, _______, _______,_______ ,                          _______ ,KP_SLASH,  KP_7  ,  KP_8  ,  KP_9  , KP_STAR,_______ ,
  //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤                         ├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     _______ , _______, KC_LPRN, KC_RPRN, _______, _______,_______ ,                          _______ ,KP_MINUS,  KP_4  ,  KP_5  ,  KP_6  , KP_PLUS,_______ ,
  //├────────┼────────┼────────┼────────┼────────┼────────┼────────┼────────┐       ┌────────┼────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     _______ , _______, BR_LCBR, BR_RCBR, _______, _______,_______ ,_______ ,        _______ ,_______ , KP_EQUL,  KP_1  ,  KP_2  ,  KP_3  , KP_EQUL,_______ ,
  //├────────┼────────┼────────┼────────┼────┬───┴────┬───┼────────┼────────┤       ├────────┼────────┼───┬────┴───┬────┼────────┼────────┼────────┼────────┤
     _______ ,_______ ,_______ ,_______ ,     _______ ,    _______ ,_______ ,        KP_ENTR ,KC_SPC  ,    KC_TAB  ,       KP_0  ,  KP_DOT,_______ ,_______
  //└────────┴────────┴────────┴────────┘    └────────┘   └────────┴────────┘       └────────┴────────┘   └────────┘    └────────┴────────┴────────┴────────┘
  ),

  // [_TRANS] = LAYOUT(
  // //┌────────┬────────┬────────┬────────┬────────┬────────┐                                           ┌────────┬────────┬────────┬────────┬────────┬────────┐
  //    _______ ,_______ ,_______ ,_______ ,_______ ,_______ ,                                            _______ ,_______ ,_______ ,_______ ,_______ ,_______ ,
  // //├────────┼────────┼────────┼────────┼────────┼────────┼────────┐                         ┌────────┼────────┼────────┼────────┼────────┼────────┼────────┤
  //    _______ ,_______ ,_______ ,_______ ,_______ ,_______ ,_______ ,                          _______ ,_______ ,_______ ,_______ ,_______ ,_______ ,_______ ,
  // //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤                         ├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
  //    _______ ,_______ ,_______ ,_______ ,_______ ,_______ ,_______ ,                          _______ ,_______ ,_______ ,_______ ,_______ ,_______ ,_______ ,
  // //├────────┼────────┼────────┼────────┼────────┼────────┼────────┼────────┐       ┌────────┼────────┼────────┼────────┼────────┼────────┼────────┼────────┤
  //    _______ ,_______ ,_______ ,_______ ,_______ ,_______ ,_______ ,_______ ,        _______ ,_______ ,_______ ,_______ ,_______ ,_______ ,_______ ,_______ ,
  // //├────────┼────────┼────────┼────────┼────┬───┴────┬───┼────────┼────────┤       ├────────┼────────┼───┬────┴───┬────┼────────┼────────┼────────┼────────┤
  //    _______ ,_______ ,_______ ,_______ ,     _______ ,    _______ ,_______ ,        _______ ,_______ ,    _______ ,     _______ ,_______ ,_______ ,_______
  // //└────────┴────────┴────────┴────────┘    └────────┘   └────────┴────────┘       └────────┴────────┘   └────────┘    └────────┴────────┴────────┴────────┘
  // )
};

void persistent_default_layer_set(uint16_t default_layer) {
    eeconfig_update_default_layer(default_layer);
    default_layer_set(default_layer);
}

layer_state_t layer_state_set_user(layer_state_t state) {
  switch(get_highest_layer(state)) {
  case _NUMPAD:
    // turn on numlock, if it isn't already on.
    if (!(host_keyboard_led_state().num_lock)) {
      register_code(KC_NUM_LOCK);
      unregister_code(KC_NUM_LOCK);
    }
    break;
  }
  return state;
};

bool process_record_user(uint16_t keycode, keyrecord_t *record) {
    switch (keycode) {
        case K_VIMCMD:
            SEND_STRING(SS_TAP(X_ESC) SS_DELAY(30) ":");
            break;
    }
    return true;
}
